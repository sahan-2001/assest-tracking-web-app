<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Booking</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .asset-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }
        .asset-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .asset-details {
            margin-bottom: 10px;
            color: #555;
        }
        .book-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .book-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .booking-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        .booked {
            background-color: #ffebee;
            color: #c62828;
        }
        .available {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        #asset-info {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Asset Booking System</h1>
        
        <div id="asset-selection">
            <h2>Select Asset to Book</h2>
            <div id="assets-list">
                <!-- Assets will be loaded here -->
            </div>
        </div>
        
        <div id="asset-info">
            <h2>Booking Information</h2>
            <div id="booking-details">
                Select an asset to view booking details
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadAssets();
        });

        function loadAssets() {
            fetch('/api/assets/all')
                .then(response => response.json())
                .then(data => {
                    const assetsList = document.getElementById('assets-list');
                    assetsList.innerHTML = '';
                    
                    data.assets.forEach(asset => {
                        const assetCard = document.createElement('div');
                        assetCard.className = 'asset-card';
                        assetCard.dataset.assetId = asset.properties.id;
                        
                        assetCard.innerHTML = `
                            <div class="asset-name">${asset.properties.name}</div>
                            <div class="asset-details">
                                Type: ${asset.properties.asset_type}<br>
                                Last seen: ${asset.properties.last_seen}
                            </div>
                            <button class="book-btn" onclick="bookAsset('${asset.properties.id}')">Book Asset</button>
                            <div id="status-${asset.properties.id}" class="booking-status"></div>
                        `;
                        
                        assetsList.appendChild(assetCard);
                        checkBookingStatus(asset.properties.id);
                    });
                })
                .catch(error => {
                    console.error('Error loading assets:', error);
                });
        }

        function checkBookingStatus(assetId) {
            fetch(`/booking/status/${assetId}`)
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById(`status-${assetId}`);
                    const button = document.querySelector(`[data-asset-id="${assetId}"] .book-btn`);
                    
                    if (data.is_booked) {
                        statusDiv.className = 'booking-status booked';
                        statusDiv.innerHTML = `Booked by: ${data.booking.user_id}<br>
                                            Since: ${new Date(data.booking.start_time).toLocaleString()}`;
                        button.disabled = true;
                        button.textContent = 'Already Booked';
                    } else {
                        statusDiv.className = 'booking-status available';
                        statusDiv.textContent = 'Available for booking';
                        button.disabled = false;
                        button.textContent = 'Book Asset';
                    }
                });
        }

        function bookAsset(assetId) {
            const user_id = prompt("Enter your user ID (or leave blank for anonymous):") || 'anonymous';
            
            fetch('/booking/book', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    asset_id: assetId,
                    user_id: user_id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Booking successful! Booking ID: ${data.booking_id}`);
                    checkBookingStatus(assetId);
                } else {
                    alert(`Booking failed: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error booking asset:', error);
                alert('Failed to book asset. Please try again.');
            });
        }
    </script>
</body>
</html>